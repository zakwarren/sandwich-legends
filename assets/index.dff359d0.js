var k=Object.defineProperty;var S=(n,e,t)=>e in n?k(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var s=(n,e,t)=>(S(n,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function t(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerpolicy&&(a.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?a.credentials="include":o.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(o){if(o.ep)return;o.ep=!0;const a=t(o);fetch(o.href,a)}})();const c=16,u=n=>n*c,y=n=>n?{x:u(10.5)-n.x,y:u(6)-n.y}:{x:0,y:0},l=(n,e)=>`${n*c},${e*c}`,g=(n,e,t)=>{let i=n,o=e;switch(t){case"left":i-=c;break;case"right":i+=c;break;case"up":o-=c;break;case"down":o+=c;break}return{x:i,y:o}},m={personWalkingComplete:"personWalkingComplete",personStandComplete:"personStandComplete"},f=(n,e)=>{const t=new CustomEvent(n,{detail:e});document.dispatchEvent(t)},C=(n,e)=>(document.addEventListener(n,e),()=>document.removeEventListener(n,e)),E=n=>{switch(n){case"up":return"down";case"down":return"up";case"left":return"right";case"right":return"left";default:return"up"}};class P{constructor(e){s(this,"gameObjects",{});s(this,"lowerImage",new Image);s(this,"upperImage",new Image);s(this,"walls");s(this,"isCutscenePlaying",!1);s(this,"createEvent");s(this,"cutsceneSpaces");this.gameObjects=e.gameObjects,this.lowerImage.src=e.lowerSrc,this.upperImage.src=e.upperSrc,this.walls=e.walls||{},this.createEvent=e.createEvent,this.cutsceneSpaces=e.cutsceneSpaces||{}}get mapGameObjects(){return this.gameObjects}get mapWalls(){return this.walls}drawLowerImage(e,t){const i=y(t);e.drawImage(this.lowerImage,i.x,i.y)}drawUpperImage(e,t){const i=y(t);e.drawImage(this.upperImage,i.x,i.y)}isSpaceTaken(e,t,i){const{x:o,y:a}=g(e,t,i);return Boolean(this.walls[`${o},${a}`])}mountObjects(){Object.keys(this.gameObjects).forEach(e=>{const t=this.gameObjects[e];t.id=e,t.mount(this)})}async startCutscene(e){this.isCutscenePlaying=!0;for(let t=0;t<e.length;t++)await this.createEvent({map:this,event:e[t]}).init();this.isCutscenePlaying=!1,Object.values(this.gameObjects).forEach(t=>t.doBehaviourEvent(this))}checkForActionCutscene(){var o;const e=this.gameObjects.hero,t=g(e.x,e.y,e.myDirection),i=Object.values(this.gameObjects).find(a=>`${a.x},${a.y}`==`${t.x},${t.y}`);!this.isCutscenePlaying&&i&&((o=i.talking)==null?void 0:o.length)&&this.startCutscene(i.talking[0].events)}checkForFootstepCutscene(){const e=this.gameObjects.hero,t=this.cutsceneSpaces?this.cutsceneSpaces[`${e.x},${e.y}`]:void 0;!this.isCutscenePlaying&&t&&this.startCutscene(t[0].events)}addWall(e,t){this.walls[`${e},${t}`]=!0}removeWall(e,t){delete this.walls[`${e},${t}`]}moveWall(e,t,i){this.removeWall(e,t);const{x:o,y:a}=g(e,t,i);this.addWall(o,a)}}class O{constructor({buildKeyPressListener:e},t,i){s(this,"canvas");s(this,"ctx");s(this,"map",null);s(this,"buildKeyPressListener");s(this,"startMap",e=>{const t=this.overworldMaps[e];this.map=new P(t),this.map.mountObjects()});this.element=t,this.overworldMaps=i,this.canvas=this.element.querySelector(".game-canvas"),this.ctx=this.canvas.getContext("2d"),this.buildKeyPressListener=e}startGameLoop(){const e=()=>{var o,a,r,d;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const t=(o=this.map)==null?void 0:o.mapGameObjects.hero,i=Object.values(((a=this.map)==null?void 0:a.mapGameObjects)||{});i.forEach(h=>{h.update({map:this.map})}),(r=this.map)==null||r.drawLowerImage(this.ctx,t),i.sort((h,w)=>h.y-w.y).forEach(h=>{h.draw(this.ctx,t)}),(d=this.map)==null||d.drawUpperImage(this.ctx,t),requestAnimationFrame(e)};e()}bindActionInput(){this.buildKeyPressListener("Enter",()=>{var e;(e=this.map)==null||e.checkForActionCutscene()})}bindHeroPositionCheck(){C("personWalkingComplete",e=>{var i;e.detail.whoId==="hero"&&((i=this.map)==null||i.checkForFootstepCutscene())})}init(){var e;this.startMap("DemoRoom"),this.startGameLoop(),this.bindActionInput(),this.bindHeroPositionCheck(),(e=this.map)==null||e.startCutscene([{who:"hero",type:"walk",direction:"down"},{who:"hero",type:"walk",direction:"down"},{who:"npc1",type:"walk",direction:"left"},{who:"npc1",type:"walk",direction:"left"},{who:"npc1",type:"stand",direction:"up",time:800},{who:"npc1",type:"textMessage",direction:"up",text:"Hello there"},{who:"npc1",type:"walk",direction:"right"}])}}class I{constructor(){s(this,"element",null)}createElement(){this.element=document.createElement("div"),this.element.classList.add("SceneTransition")}fadeOut(){var e,t;(e=this.element)==null||e.classList.add("fade-out"),(t=this.element)==null||t.addEventListener("animationend",()=>{var i;(i=this.element)==null||i.remove()},{once:!0})}init(e,t){this.createElement(),this.element&&(e.appendChild(this.element),this.element.addEventListener("animationend",()=>{t()},{once:!0}))}}const A=()=>new I;class F{constructor({element:e,createTextMessage:t,buildKeyPressListener:i,getStartMap:o,createSceneTransition:a},{map:r,event:d}){s(this,"element");s(this,"createTextMessage");s(this,"buildKeyPressListener");s(this,"map");s(this,"event");s(this,"getStartMap");s(this,"createSceneTransition");this.element=e,this.createTextMessage=t,this.buildKeyPressListener=i,this.getStartMap=o,this.createSceneTransition=a,this.map=r,this.event=d}stand(e){this.map.mapGameObjects[this.event.who].startBehaviour({map:this.map},{type:"stand",direction:this.event.direction,time:this.event.time});const i=o=>{o.detail.whoId===this.event.who&&(document.removeEventListener(m.personStandComplete,i),e())};document.addEventListener(m.personStandComplete,i)}walk(e){this.map.mapGameObjects[this.event.who].startBehaviour({map:this.map},{type:"walk",direction:this.event.direction});const i=o=>{o.detail.whoId===this.event.who&&(document.removeEventListener(m.personWalkingComplete,i),e())};document.addEventListener(m.personWalkingComplete,i)}textMessage(e){if(this.event.faceHero){const i=this.map.mapGameObjects[this.event.faceHero];i.myDirection=E(this.map.mapGameObjects.hero.myDirection)}this.createTextMessage({text:this.event.text||"",onComplete:e,buildKeyPressListener:this.buildKeyPressListener}).init(this.element)}changeMap(e){const t=this.getStartMap(),i=this.createSceneTransition();i.init(this.element,()=>{t&&this.event.map&&(t(this.event.map),e(),i.fadeOut())})}init(){return new Promise(e=>this[this.event.type](()=>e(this.event.type)))}}const M=n=>e=>new F(n,e);class T{constructor(){s(this,"heldDirections",[]);s(this,"map",{ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right",KeyW:"up",KeyS:"down",KeyA:"left",KeyD:"right"});this.addEventListeners()}get direction(){return this.heldDirections[0]}addEventListeners(){document.addEventListener("keydown",e=>{const t=this.map[e.code];t&&!this.heldDirections.includes(t)&&this.heldDirections.unshift(t)}),document.addEventListener("keyup",e=>{const t=this.map[e.code];this.heldDirections=this.heldDirections.filter(i=>i!==t)})}}class j{constructor(e,t){s(this,"keySafe",!0);s(this,"keydownFunction");s(this,"keyupFunction");this.keyCode=e,this.callback=t,this.keydownFunction=i=>{i.code===this.keyCode&&this.keySafe&&(this.keySafe=!1,this.callback())},this.keyupFunction=i=>{i.code===this.keyCode&&(this.keySafe=!0)},document.addEventListener("keydown",this.keydownFunction),document.addEventListener("keyup",this.keyupFunction)}unbind(){document.removeEventListener("keydown",this.keydownFunction),document.removeEventListener("keyup",this.keyupFunction)}}const L=(n,e)=>new j(n,e);class D{constructor(e){s(this,"element");s(this,"text");s(this,"speed",70);s(this,"timeout",null);s(this,"isDone",!1);this.element=e.element,this.text=e.text,this.speed=e.speed||this.speed}revealOneCharacter(e){const t=e.splice(0,1)[0];t.span.classList.add("revealed"),e.length>0?this.timeout=setTimeout(()=>{this.revealOneCharacter(e)},t.delayAfter):this.isDone=!0}warpToDone(){this.timeout&&clearTimeout(this.timeout),this.isDone=!0,this.element.querySelectorAll("span").forEach(e=>e.classList.add("revealed"))}init(){const e=[];this.text.split("").forEach(t=>{const i=document.createElement("span");i.textContent=t,this.element.appendChild(i),e.push({span:i,delayAfter:t===" "?0:this.speed})}),this.revealOneCharacter(e)}}const v="TextMessage";class K{constructor({text:e,onComplete:t,buildKeyPressListener:i}){s(this,"text");s(this,"onComplete");s(this,"buildKeyPressListener");s(this,"element",null);s(this,"actionListener");s(this,"revealingText",null);s(this,"done",()=>{var e,t,i,o;(e=this.revealingText)!=null&&e.isDone?((t=this.element)==null||t.remove(),(i=this.actionListener)==null||i.unbind(),this.onComplete()):(o=this.revealingText)==null||o.warpToDone()});this.text=e,this.onComplete=t,this.buildKeyPressListener=i}createElement(){this.element=document.createElement("div"),this.element.classList.add(v);const e=document.createElement("p");e.classList.add(`${v}_p`),this.element.appendChild(e);const t=document.createElement("button");return t.classList.add(`${v}_button`),t.innerText="Next",t.addEventListener("click",this.done),this.element.appendChild(t),this.actionListener=this.buildKeyPressListener("Enter",()=>{this.done()}),e}init(e){const t=this.createElement();e.appendChild(this.element),this.revealingText=new D({text:this.text,element:t}),this.revealingText.init()}}const $=n=>new K(n);class W{constructor(e){s(this,"image",new Image);s(this,"shadow",new Image);s(this,"isLoaded",!1);s(this,"useShadow",!1);s(this,"isShadowLoaded",!1);s(this,"animations");s(this,"currentAnimation","idle-down");s(this,"currentAnimationFrame",0);s(this,"animationFrameLimit",4);s(this,"animationFrameProgress");this.image.src=e.src,this.image.onload=()=>{this.isLoaded=!0},this.useShadow=e.useShadow||!1,this.useShadow&&(this.shadow.src="/images/characters/shadow.png",this.shadow.onload=()=>{this.isShadowLoaded=!0}),this.animations=e.animations||{"idle-down":[[0,0]]},this.currentAnimation=e.currentAnimation||this.currentAnimation,this.animationFrameLimit=e.animationFrameLimit||this.animationFrameLimit,this.animationFrameProgress=this.animationFrameLimit}get frame(){const e=this.animations[this.currentAnimation];if(!!e)return e[this.currentAnimationFrame]}get currentAnimationKey(){return this.currentAnimation}setAnimation(e){this.currentAnimation!==e&&(this.currentAnimation=e,this.currentAnimationFrame=0,this.animationFrameProgress=this.animationFrameLimit)}updateAnimationProgress(){if(this.animationFrameProgress>0){this.animationFrameProgress-=1;return}this.animationFrameProgress=this.animationFrameLimit,this.currentAnimationFrame+=1,this.frame===void 0&&(this.currentAnimationFrame=0)}draw(e,t,i){const o=y(i),a=t.x-8+o.x,r=t.y-18+o.y;this.isShadowLoaded&&e.drawImage(this.shadow,a,r);const d=this.frame||[0,0],[h,w]=d;this.isLoaded&&e.drawImage(this.image,h*32,w*32,32,32,a,r,32,32),this.updateAnimationProgress()}}class G{constructor(e){s(this,"id","");s(this,"isMounted",!1);s(this,"isStanding",!1);s(this,"x",0);s(this,"y",0);s(this,"sprite");s(this,"direction","down");s(this,"directionInput",null);s(this,"behaviourLoop",[]);s(this,"behaviourLoopIndex",0);s(this,"createEvent");s(this,"talking");this.x=u(e.x),this.y=u(e.y),this.sprite=new W({src:e.src,animations:e.animations||{"idle-down":[[0,0]]},useShadow:!0}),this.direction=e.direction||"down",this.directionInput=e.directionInput||null,this.behaviourLoop=e.behaviourLoop||this.behaviourLoop,this.createEvent=e.createEvent,this.talking=e.talking}get myDirection(){return this.direction}set myDirection(e){this.direction=e}async doBehaviourEvent(e){if(e.isCutscenePlaying||this.behaviourLoop.length===0||this.isStanding)return;const t={...this.behaviourLoop[this.behaviourLoopIndex],who:this.id};await this.createEvent({map:e,event:t}).init(),this.behaviourLoopIndex+=1,this.behaviourLoopIndex===this.behaviourLoop.length&&(this.behaviourLoopIndex=0),this.doBehaviourEvent(e)}mount(e){this.isMounted=!0,e.addWall(this.x,this.y),setTimeout(()=>this.doBehaviourEvent(e),10)}draw(e,t){this.sprite.draw(e,this,t)}setAnimation(e){this.sprite.setAnimation(e)}update(e){}startBehaviour(e,t){}}class p extends G{constructor(t){const i={"idle-down":[[0,0]],"idle-right":[[0,1]],"idle-up":[[0,2]],"idle-left":[[0,3]],"walk-down":[[1,0],[0,0],[3,0],[0,0]],"walk-right":[[1,1],[0,1],[3,1],[0,1]],"walk-up":[[1,2],[0,2],[3,2],[0,2]],"walk-left":[[1,3],[0,3],[3,3],[0,3]]};t.animations=i;super(t);s(this,"movingProgressRemaining",0);s(this,"directionUpdate",new Map([["up",["y",-1]],["down",["y",1]],["left",["x",-1]],["right",["x",1]]]))}updatePosition(){const[t,i]=this.directionUpdate.get(this.direction);this[t]+=i,this.movingProgressRemaining-=1,this.movingProgressRemaining===0&&f(m.personWalkingComplete,{whoId:this.id})}updateSprite(){if(this.movingProgressRemaining>0){this.setAnimation(`walk-${this.direction}`);return}this.setAnimation(`idle-${this.direction}`)}startBehaviour({map:t},i){this.direction=i.direction,i.type==="walk"&&!t.isSpaceTaken(this.x,this.y,this.direction)&&(t.moveWall(this.x,this.y,this.direction),this.movingProgressRemaining=c,this.updateSprite()),i.type==="stand"&&(this.isStanding=!0,setTimeout(()=>{f(m.personStandComplete,{whoId:this.id}),this.isStanding=!1},i.time))}update(t){var i;this.movingProgressRemaining>0?this.updatePosition():(!t.map.isCutscenePlaying&&((i=this.directionInput)==null?void 0:i.direction)&&this.startBehaviour(t,{type:"walk",direction:this.directionInput.direction}),this.updateSprite())}}const R=(n,e)=>({lowerSrc:"/images/maps/DemoLower.png",upperSrc:"/images/maps/DemoUpper.png",createEvent:e,gameObjects:{hero:new p({x:5,y:6,src:"/images/characters/people/hero.png",createEvent:e,directionInput:n}),npc1:new p({x:7,y:9,src:"/images/characters/people/npc1.png",createEvent:e,behaviourLoop:[{type:"stand",direction:"left",time:800},{type:"stand",direction:"up",time:800},{type:"stand",direction:"right",time:1200},{type:"stand",direction:"up",time:300}],talking:[{events:[{type:"textMessage",who:"npc1",direction:"up",text:"I'm working here..."},{type:"walk",who:"hero",direction:"up"}]}]}),npc2:new p({x:8,y:5,src:"/images/characters/people/npc2.png",createEvent:e})},walls:{[l(7,6)]:!0,[l(8,6)]:!0,[l(7,7)]:!0,[l(8,7)]:!0},cutsceneSpaces:{[l(7,4)]:[{events:[{who:"npc2",type:"walk",direction:"left"},{who:"npc2",type:"stand",direction:"up",time:500},{who:"npc2",type:"textMessage",direction:"up",text:"You can't be in there!"},{who:"npc2",type:"walk",direction:"right"},{who:"npc2",type:"stand",direction:"down"},{who:"hero",type:"walk",direction:"down"},{who:"hero",type:"walk",direction:"left"}]}],[l(5,10)]:[{events:[{type:"changeMap",who:"hero",direction:"down",map:"Kitchen"}]}]}}),H=(n,e)=>({lowerSrc:"/images/maps/KitchenLower.png",upperSrc:"/images/maps/KitchenUpper.png",createEvent:e,gameObjects:{hero:new p({x:3,y:5,src:"/images/characters/people/hero.png",createEvent:e,directionInput:n}),npc1:new p({x:9,y:6,src:"/images/characters/people/npc1.png",createEvent:e}),npc2:new p({x:10,y:8,src:"/images/characters/people/npc2.png",createEvent:e,talking:[{events:[{type:"textMessage",who:"npc2",direction:"up",faceHero:"npc2",text:"You made it!"}]}]})}}),B=(n,e)=>({DemoRoom:R(n,e),Kitchen:H(n,e)});let b=null;const U=()=>b,_=M({element:document.querySelector(".game-container"),createTextMessage:$,buildKeyPressListener:L,getStartMap:U,createSceneTransition:A}),q=new T,N=B(q,_),x=document.querySelector(".game-container");if(x){const n=new O({buildKeyPressListener:L},x,N);b=n.startMap,n.init()}
